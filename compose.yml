# Sabakan Container Compose Configuration
# Use with: podman compose up -d

services:
  # Redis for JWT session management and caching
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data:Z
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    restart: unless-stopped

  # Development service (default) - for testing container management
  sabakan-dev:
    build:
      context: .
      dockerfile: Containerfile.dev
    ports:
      - "1323:1323"   # Backend API
      - "4200:4200"   # Angular dev server
      - "6006:6006"   # Storybook
    privileged: true
    stdin_open: true
    tty: true
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379

  # Production service using multi-stage build
  sabakan:
    build:
      context: .
      dockerfile: Containerfile
    ports:
      - "1323:1323"
    volumes:
      # Mount Podman socket for container management
      - /run/podman/podman.sock:/run/podman/podman.sock:Z
      # Persistent data volume
      - sabakan-data:/data:Z
      # Configuration file (create from config.example.toml)
      - ./backend/config.toml:/app/config.toml:ro,Z
    environment:
      - CONFIG_PATH=/app/config.toml
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:1323/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    profiles:
      - prod

  # Backend-only for testing
  backend-test:
    build:
      context: ./backend
      dockerfile: Dockerfile
    volumes:
      - ./backend:/app
    command: go test ./... -v
    profiles:
      - test

volumes:
  sabakan-data:
  redis-data:

